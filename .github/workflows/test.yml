name: Vesting Smart Contract Tests

on:
  push:
    branches: [ "main", "issue-17-lazy-storage-optimization", "issue-18-invariant-tests-clean" ]
  pull_request:
    branches: [ "main", "issue-17-lazy-storage-optimization", "issue-18-invariant-tests-clean" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        working-directory:
          - .
          - ./contracts/vesting_contracts
    defaults:
      run:
        working-directory: ${{ matrix.working-directory }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          override: true
          components: rustfmt, clippy

      - name: Install Stellar CLI
        run: |
          # Try official installation method first
          echo "Attempting official installation method..."
          if command -v cargo &> /dev/null; then
            echo "Installing via cargo..."
            cargo install stellar-cli --version 25.1.0 --locked
            if [ $? -eq 0 ]; then
              echo "Successfully installed via cargo"
              stellar --version
              exit 0
            fi
          fi
          
          echo "Cargo installation failed, trying manual installation..."
          wget https://github.com/stellar/stellar-cli/releases/download/v25.1.0/stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          echo "Directory contents:"
          ls -la stellar-cli-25.1.0-x86_64-unknown-linux-gnu/
          echo "Looking for binary..."
          
          # The binary is likely named 'stellar-cli' based on the package name
          BINARY_PATH=""
          if [ -f "stellar-cli-25.1.0-x86_64-unknown-linux-gnu/stellar" ]; then
            BINARY_PATH="stellar-cli-25.1.0-x86_64-unknown-linux-gnu/stellar"
            BINARY_NAME="stellar"
          elif [ -f "stellar-cli-25.1.0-x86_64-unknown-linux-gnu/stellar-cli" ]; then
            BINARY_PATH="stellar-cli-25.1.0-x86_64-unknown-linux-gnu/stellar-cli"
            BINARY_NAME="stellar-cli"
          else
            echo "Error: Could not find stellar binary in extracted directory"
            echo "All files in directory:"
            find stellar-cli-25.1.0-x86_64-unknown-linux-gnu/ -type f
            exit 1
          fi
          
          echo "Found binary: $BINARY_PATH"
          echo "Installing as: $BINARY_NAME"
          
          sudo mv "$BINARY_PATH" "/usr/local/bin/$BINARY_NAME"
          sudo chmod +x "/usr/local/bin/$BINARY_NAME"
          
          echo "Testing installation:"
          which "$BINARY_NAME"
          "$BINARY_NAME" --version

      - name: Build Contract
        run: cargo build --target wasm32-unknown-unknown --release

      - name: Run Unit Tests
        run: cargo test --lib

      - name: Run Integration Tests
        run: cargo test --test '*'
